generator client {
  provider = "prisma-client-js"
}


datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum ProjectAccess {
  VIEW
  EDIT
}

enum InviteStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  username  String   @unique
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects Project[] @relation("user_projects")

  memberships ProjectMember[]

  sentInvites ProjectInvite[]
}

type ProjectRepo {
  provider String
  owner    String
  name     String
}

model Project {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  repo ProjectRepo?

  ownerId String @db.ObjectId
  owner   User   @relation("user_projects", fields: [ownerId], references: [id])

  environments Environment[] @relation("project_environments")

  members ProjectMember[]

  invites ProjectInvite[]
}

model Environment {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  projectId String  @db.ObjectId
  project   Project @relation("project_environments", fields: [projectId], references: [id])

  variables EnvironmentVariable[] @relation("environment_variables")
}

model EnvironmentVariable {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  value       String
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  environmentId String      @db.ObjectId
  environment   Environment @relation("environment_variables", fields: [environmentId], references: [id])
}

model ProjectMember {
  id     String        @id @default(auto()) @map("_id") @db.ObjectId
  access ProjectAccess @default(VIEW)

  userId    String @db.ObjectId
  projectId String @db.ObjectId

  user    User    @relation(fields: [userId], references: [id])
  project Project @relation(fields: [projectId], references: [id])

  createdAt DateTime @default(now())

  @@unique([userId, projectId])
}

model ProjectInvite {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  projectId String  @db.ObjectId
  project   Project @relation(fields: [projectId], references: [id])

  invitedById String @db.ObjectId
  invitedBy   User   @relation(fields: [invitedById], references: [id])

  inviteEmail String
  access      ProjectAccess @default(VIEW)

  status InviteStatus @default(PENDING)

  token     String   @unique
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([inviteEmail])
}
